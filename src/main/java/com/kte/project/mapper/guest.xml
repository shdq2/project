<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="guest">
	<select id="guest_reser" resultType="reservationVO" parameterType="String">
		select r.*,rs.reser_title from reservation_state rs
	    inner join(
	    SELECT reser_code,count(*) as reser_count FROM ksm.reservation where custom_id=#{id} group by reser_code
		union all
		select reser_code,0 from reservation where reser_code not in(select reser_code from reservation where custom_id=#{id})
		order by reser_code) r
	    on r.reser_code = rs.reser_code;
	</select>	
	<select id="guest_reser_list" parameterType="String" resultType="reservationVO">
		select r.host_name,r.room_code,r.room_name,r.host_id,r.reser_title,r.reser_code,
		date_format(r.reservation_start,"%Y-%m-%d") as reservation_start,date_format(r.reservation_end,"%Y-%m-%d") as reservation_end,r.reservation_people,
		TO_DAYS(r.reservation_end) - TO_DAYS(r.reservation_start) as reser_day,r.dayofweek_start,r.dayofweek_end
		from custom c 
			inner join
				(select c.custom_name as host_name,r.host_id,r.room_code,r.guest_id,r.reservation_code,r.reser_title,r.reser_code,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
				r.reservation_start,r.reservation_end,r.room_name from custom c
				inner join
					(select rs.reser_title,r.room_code,r.host_id,r.guest_id,r.reser_code,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
						r.reservation_start,r.reservation_end,r.room_name,r.reservation_code from reservation_state rs
						inner join
						(select ro.room_code,ro.custom_id as host_id,re.custom_id as guest_id,re.reser_code,
						re.reservation_start,re.reservation_end,ro.room_name,re.reservation_code,re.reservation_people,
						case WEEKDAY(re.reservation_start) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
			    		end as dayofweek_start,
			    		case WEEKDAY(re.reservation_end) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
					    end as dayofweek_end
						from reservation re
						inner join room ro
						on re.room_code = ro.room_code) r
					on r.reser_code = rs.reser_code) r					
			on c.custom_id = r.host_id) r
		on c.custom_id = r.guest_id
        where c.custom_id = #{id}
		order by r.reservation_code desc
	</select>
	<select id="select_guest_reser_list" parameterType="reservationVO" resultType="reservationVO">
		select r.host_name,r.room_code,r.room_name,r.host_id,r.reser_title,r.reser_code,
		date_format(r.reservation_start,"%Y-%m-%d") as reservation_start,date_format(r.reservation_end,"%Y-%m-%d") as reservation_end,r.reservation_people,
		TO_DAYS(r.reservation_end) - TO_DAYS(r.reservation_start) as reser_day,r.dayofweek_start,r.dayofweek_end
		from custom c 
			inner join
				(select c.custom_name as host_name,r.host_id,r.room_code,r.guest_id,r.reservation_code,r.reser_title,r.reser_code,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
				r.reservation_start,r.reservation_end,r.room_name from custom c
				inner join
					(select rs.reser_title,r.room_code,r.host_id,r.guest_id,r.reser_code,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
						r.reservation_start,r.reservation_end,r.room_name,r.reservation_code from reservation_state rs
						inner join
						(select ro.room_code,ro.custom_id as host_id,re.custom_id as guest_id,re.reser_code,
						re.reservation_start,re.reservation_end,ro.room_name,re.reservation_code,re.reservation_people,
						case WEEKDAY(re.reservation_start) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
			    		end as dayofweek_start,
			    		case WEEKDAY(re.reservation_end) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
					    end as dayofweek_end
						from reservation re
						inner join room ro
						on re.room_code = ro.room_code) r
					on r.reser_code = rs.reser_code) r					
			on c.custom_id = r.host_id) r
		on c.custom_id = r.guest_id
        where c.custom_id = #{custom_id} and reser_code = #{state_count}
		order by r.reservation_code desc
	</select>
</mapper>