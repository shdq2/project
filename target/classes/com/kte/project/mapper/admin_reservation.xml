<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin_reservation">
	<resultMap id="resultImg" type="customVO">
		<result column="custom_img" property="custom_img" jdbcType="BLOB" />	
	</resultMap>
	
	<select id = "reservation_member" parameterType="reservationVO" resultType="reservationVO">
		select 
		r.reservation_code,r.custom_id,r.room_code,date_format(r.reservation_start,'%Y-%m-%d') as reservation_start,date_format(r.reservation_end,'%Y-%m-%d') as reservation_end,r.reser_title, 
		ro.room_name,(to_days(r.reservation_end)-to_days(r.reservation_start)) as reser_day
		from room ro
		inner join
			(select r.reservation_code,r.custom_id,r.room_code,r.reservation_start,r.reservation_end,rs.reser_title from reservation r
			inner join reservation_state rs
			on r.reser_code = rs.reser_code) r
		on ro.room_code = r.room_code
		where r.custom_id = #{custom_id} 
		order by r.reservation_code desc
		limit #{page},6
	</select>
	
	<select id="reser_total" resultType="Int" parameterType="String">
		select count(*) from reservation where custom_id=#{id}
	</select>
	
	<select id="reservation_all" resultType="reservationVO" parameterType="Int">
		select c.custom_name as guest_name,r.host_name,r.room_code,r.room_name,r.guest_id,r.host_id,r.reservation_code,r.reser_title,r.reser_code,
		date_format(r.reservation_start,"%Y-%m-%d") as reservation_start,date_format(r.reservation_end,"%Y-%m-%d") as reservation_end,r.reservation_people,
		TO_DAYS(r.reservation_end) - TO_DAYS(r.reservation_start) as reser_day,r.room_day,r.dayofweek_start,r.dayofweek_end
		from custom c 
			inner join
				(select c.custom_name as host_name,r.host_id,r.room_code,r.guest_id,r.reservation_code,r.reser_title,r.room_day,r.reser_code,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
				r.reservation_start,r.reservation_end,r.room_name from custom c
				inner join
					(select rs.reser_title,r.room_code,r.host_id,r.guest_id,r.reser_code,r.room_day,r.dayofweek_start,r.dayofweek_end,r.reservation_people,
						r.reservation_start,r.reservation_end,r.room_name,r.reservation_code from reservation_state rs
						inner join
						(select ro.room_code,ro.custom_id as host_id,re.custom_id as guest_id,re.reser_code,ro.room_day,
						re.reservation_start,re.reservation_end,ro.room_name,re.reservation_code,re.reservation_people,
						case WEEKDAY(re.reservation_start) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
			    		end as dayofweek_start,
			    		case WEEKDAY(re.reservation_end) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
					    end as dayofweek_end
						from reservation re
						inner join room ro
						on re.room_code = ro.room_code) r
					on r.reser_code = rs.reser_code) r					
			on c.custom_id = r.host_id) r
		on c.custom_id = r.guest_id
		order by r.reservation_code desc
		limit #{page},10
	</select>
	
	<select id="profile_img" parameterType="String" resultType="Int">
		select ifnull(min(img_code),-1) from custom_profile where custom_id = #{id}
	</select>
	
	<select id="select_reser" parameterType="Int" resultType="reservationVO">
		select r.*,ro.room_name,ro.room_day from room ro
		inner join
		(select r.reservation_code, r.room_code,
		date_format(r.reservation_start,'%Y년 %m월 %d일') as reservation_start,
		date_format(r.reservation_end,'%Y년 %m 월 %d일') as reservation_end,
		TO_DAYS(r.reservation_end) - TO_DAYS(r.reservation_start) as reser_day,
		case WEEKDAY(r.reservation_start) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
			    		end as dayofweek_start,
			    		case WEEKDAY(r.reservation_end) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
					    end as dayofweek_end 
		from reservation r 
		inner join reservation_state s
		on r.reser_code = s.reser_code) r
		on r.room_code = ro.room_code		
		where r.reservation_code = #{code}
	</select>
	
	<update id="update_state" parameterType="reservationVO">
		update reservation set reser_code = #{reser_code} where reservation_code = #{reservation_code}
	</update>
	
	<select id="state_count" parameterType="Int" resultType="reservationVO">
		select r.reser_code, count(r.reser_code) as state_count,rs.reser_title from reservation r 
		inner join reservation_state rs
		on r.reser_code = rs.reser_code
		group by reser_code
		union all
		select reser_code,0 as count,reser_title from reservation_state where reser_code not in (select reser_code from reservation)
		order by reser_code
	</select>
	
	<select id="reser_count" resultType="Int">
		select count(*) from reservation
	</select>
	<select id="reser_count_state" resultType="Int" parameterType="Int">
		select count(*) from reservation where reser_code = #{state}
	</select>
	
	<select id="admin_show_profile" parameterType="String" resultMap="resultImg">
		select custom_img from custom_profile where img_code in (select ifnull(min(img_code),-1) from custom_profile where custom_id=#{id}) 
	</select>
	
	<select id="admin_custom" parameterType="String" resultType="customVO">
		select c.*,b.bank_name from custom c 
		left outer join bank b
		on c.bank_code = b.bank_code
        where c.custom_id=#{id}
	</select>
	<select id="reser_member_count" parameterType="String" resultType="Int">
		select count(*) as count from reservation 
		where custom_id = #{id} and reser_code = 4
	</select>
	<select id="reservation_all_sort" resultType="reservationVO" parameterType="ReservationVO">
		select c.custom_name as guest_name,r.host_name,r.room_code,r.room_name,r.guest_id,r.host_id,r.reservation_code,r.reser_title,r.reser_code,
		date_format(r.reservation_start,"%Y-%m-%d") as reservation_start,date_format(r.reservation_end,"%Y-%m-%d") as reservation_end,
		TO_DAYS(r.reservation_end) - TO_DAYS(r.reservation_start) as reser_day,r.room_day,r.dayofweek_start,r.dayofweek_end
		from custom c 
			inner join
				(select c.custom_name as host_name,r.host_id,r.room_code,r.guest_id,r.reservation_code,r.reser_title,r.room_day,r.reser_code,r.dayofweek_start,r.dayofweek_end,
				r.reservation_start,r.reservation_end,r.room_name from custom c
				inner join
					(select rs.reser_title,r.room_code,r.host_id,r.guest_id,r.reser_code,r.room_day,r.dayofweek_start,r.dayofweek_end,
						r.reservation_start,r.reservation_end,r.room_name,r.reservation_code from reservation_state rs
						inner join
						(select ro.room_code,ro.custom_id as host_id,re.custom_id as guest_id,re.reser_code,ro.room_day,
						re.reservation_start,re.reservation_end,ro.room_name,re.reservation_code,
						case WEEKDAY(re.reservation_start) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
			    		end as dayofweek_start,
			    		case WEEKDAY(re.reservation_end) 
							when '0' then '월'
							when '1' then '화'
							when '2' then '수'
							when '3' then '목'
							when '4' then '금'
							when '5' then '토'
							when '6' then '일'
					    end as dayofweek_end
						from reservation re
						inner join room ro
						on re.room_code = ro.room_code) r
					on r.reser_code = rs.reser_code) r					
			on c.custom_id = r.host_id) r
		on c.custom_id = r.guest_id
		where r.reser_code = #{state_count}
		order by r.reservation_code desc
		limit #{page},10
	</select>
	
	<select id="reservation_search" resultType="reservationVO" parameterType="ReservationVO">
		call reser_search(
			#{type,mode=IN},
			#{txt,mode=IN}
		)
	</select>
	
	</mapper>
